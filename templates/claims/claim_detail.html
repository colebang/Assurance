{% extends 'base.html' %}
{% load accounts_extras %}
{% block title %}Claim {{ claim.public_code }}{% endblock %}
{% block content %}
<h2>Claim {{ claim.public_code }}</h2>
<p>Assur√©: {{ claim.policy.insured }}</p>
<p>Produit: {{ claim.policy.product.name }}</p>
<p>Status: {{ claim.status }}</p>
<table>
  <thead>
    <tr>
      <th>Coverage</th>
      <th>Invoice</th>
      {% if not user|has_group:'redacteur' %}
      <th>Eligible</th>
      <th>Approved</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for line in claim.lines.all %}
    <tr>
      <td>{{ line.policy_coverage.coverage.name }}</td>
      <td>{{ line.line_invoice_amount }}</td>
      {% if not user|has_group:'redacteur' %}
      <td>{{ line.line_eligible_amount }}</td>
      <td>{{ line.line_approved_amount }}</td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
</table>
<h3>Attachments</h3>
<ul>
  {% for att in claim.attachments.all %}
  <li>{{ att.file.name }}</li>
  {% endfor %}
</ul>
<h3>Payments</h3>
<ul>
  {% for pay in claim.payments.all %}
  <li>{{ pay.amount }} - {{ pay.mode }} - {{ pay.paid_at }}</li>
  {% empty %}
  <li>No payments</li>
  {% endfor %}
</ul>
{% if claim.status == 'SUBMITTED' and perms.claims.approve_claim %}
<form action="{% url 'claims:claim_approve' claim.pk %}" method="post" style="display:inline">
  {% csrf_token %}
  <button type="submit">Approve</button>
</form>
{% endif %}
{% if claim.status == 'SUBMITTED' and perms.claims.reject_claim %}
<form action="{% url 'claims:claim_reject' claim.pk %}" method="post" style="display:inline">
  {% csrf_token %}
  <button type="submit">Reject</button>
</form>
{% endif %}
{% if claim.status == 'APPROVED' and claim.paid_amount < claim.reimbursable_amount and perms.finance.pay_claim %}
<a href="{% url 'finance:payment_create' claim.pk %}">Pay</a>
{% endif %}
{% endblock %}
